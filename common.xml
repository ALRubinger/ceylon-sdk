<project>
  <echo message="${ant.project.name} basedir:${basedir}, build: ${build}"/>
  
  <property file="../build.properties"/>
  <property name="module.build.properties" value="${ant.project.name}.build.properties"/>
  <available file="${module.build.properties}" property="module.build.properties.exist"/>
  <fail message="${module.build.properties} file doesn't exist in ${ant.project.name}" unless="module.build.properties.exist"/>
  <property file="${ant.project.name}.build.properties"/>
  <fail message="${module.build.properties} didn't specify a module.version property" unless="module.version"/>
  
  <!-- usually the modules build properties don't need to set a module.name
  because the following default just works, but not for sdk-test -->
  <property name="module.name" value="ceylon.${ant.project.name}"/>
  <echo message="######### module = ${module.name}"/>
  
  <!-- set these if not already set by the master build.xml.
       build dir is different if you do a top-level build or a module specific 
       build. This allows you to build each module independently. 
       But only if you've done a top-level ant build first, so the 
       repo.dependencies repo is populated --> 
  <property name="build" location="build"/>
  <property name="build.modules" location="${build}/modules"/>
  <property name="test.reports" location="${build}/test-reports"/>
  <property name="repo.dependancies" location="../build/modules"/>
  <condition property="tests.exist">
    <resourceexists>
      <file file="test"/>
    </resourceexists>
  </condition>
  
  <path id="ant-tasks">
    <pathelement location="${ceylon.ant.lib}"/>
  </path>
  
  <taskdef name="ceylonc" classname="com.redhat.ceylon.ant.Ceylonc" classpathref="ant-tasks"/>
  <taskdef name="ceylond" classname="com.redhat.ceylon.ant.Ceylond" classpathref="ant-tasks"/>
  <taskdef name="ceylon" classname="com.redhat.ceylon.ant.Ceylon" classpathref="ant-tasks"/>

  <target name="clean-module">
    <echo message="${ant.project.name} clean basedir:${basedir}, build: ${build}"/>
    <delete dir="${build}"/>
  </target>
  
  <target name="-init">
    <echo message="${ant.project.name} -init basedir:${basedir}, build: ${build}"/>
    <mkdir dir="${build}"/>
  </target>
  
  <target name="compile-module" depends="-init">
    <echo message="${ant.project.name} compile basedir:${basedir}, build: ${build}"/>
    <ceylonc executable="${basedir}/../../ceylon-dist/dist/bin/ceylonc"
      out="${build.modules}">
      <rep url="${repo.dependancies}"/>
      <module name="${module.name}"/>
    </ceylonc>
  </target>
    
  <target name="test-module" depends="compile-module" if="tests.exist">
    <echo message="${ant.project.name} test basedir:${basedir}, build: ${build}"/>
    <!-- compile the tests -->
    
    <ceylonc executable="${basedir}/../../ceylon-dist/dist/bin/ceylonc"
      src="test"
      out="${build.modules}">
      <rep url="${repo.dependancies}"/>
      <module name="test.${module.name}"/>
    </ceylonc>
    <!-- Run the tests -->
    <ceylon executable="${basedir}/../../ceylon-dist/dist/bin/ceylon"
        run="test.${module.name}.run" module="test.${module.name}/${module.version}">
        <rep url="${repo.dependancies}"/>
        <rep url="${build.modules}"/>
    </ceylon>
  </target>
  
  <target name="doc-module" depends="-init">
    <echo message="${ant.project.name} doc basedir:${basedir}, build: ${build}"/>
    <ceylond executable="${basedir}/../../ceylon-dist/dist/bin/ceylond"
        out="${build.modules}">
      <rep url="${repo.dependancies}"/>
      <module name="${module.name}"/>
    </ceylond>
  </target>
  
  <target name="publish-module" depends="compile-module, doc-module">
    <echo message="${ant.project.name} publish basedir:${basedir}, build: ${build}"/>
    <property name="ceylon.repo.dir" location="${user.home}/.ceylon/repo"/>
    <property name="publish.dir" location="${ceylon.repo.dir}/"/>
    <echo message="Copying to ${publish.dir}"/>
    <copy todir="${publish.dir}">
        <fileset dir="${build.modules}">
          <include name="**/${module.name}-${module.version}.*"/>
        </fileset>
    </copy>
    <!--
    <ceylonr executable="../ceylon-dist/dist/bin/ceylonr"
        out="${publish.repo}"
        pass="${publish.password}"
        user="${publish.username}">
      <rep url="${build.modules}"/>
      <rep url="${repo.dependancies}"/>
      <module name="${module.name}" version="${module.version}"/>
    </ceylonr>-->
  </target>

</project>
